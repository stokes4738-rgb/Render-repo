# Deploying PocketBounty to Render

## Prerequisites
- GitHub account
- Render account (https://render.com)
- Stripe account for payment processing
- SendGrid account for email (optional)
- PostgreSQL database (Render provides one, or use Neon/Supabase)

## Step 1: Push to GitHub

1. Initialize git repository (if not already done):
```bash
git init
git add .
git commit -m "Initial commit for Render deployment"
```

2. Create a new repository on GitHub
3. Push your code:
```bash
git remote add origin https://github.com/YOUR_USERNAME/pocketbounty.git
git branch -M main
git push -u origin main
```

## Step 2: Deploy on Render

1. Go to [Render Dashboard](https://dashboard.render.com)
2. Click "New +" → "Web Service"
3. Connect your GitHub account and select the `pocketbounty` repository
4. Render will automatically detect the `render.yaml` configuration

## Step 3: Configure Environment Variables

In Render Dashboard, set the following environment variables:

### Required Variables:
- `DATABASE_URL`: Your PostgreSQL connection string
  - Format: `postgres://USER:PASS@HOST:5432/DBNAME`
  - If using Render PostgreSQL, this is automatically set
  - If using Neon: Get from Neon dashboard
  - If using Supabase: Get from Supabase settings

- `STRIPE_SECRET_KEY`: Your Stripe secret key (starts with `sk_live_`)
  - Get from https://dashboard.stripe.com/apikeys

- `STRIPE_WEBHOOK_SECRET`: Your Stripe webhook endpoint secret (starts with `whsec_`)
  - Will be generated after setting up webhook (see Step 4)

- `VITE_STRIPE_PUBLIC_KEY`: Your Stripe publishable key (starts with `pk_live_`)
  - Get from https://dashboard.stripe.com/apikeys

- `SENDGRID_API_KEY`: Your SendGrid API key (starts with `SG.`)
  - Get from https://app.sendgrid.com/settings/api_keys

### Optional Variables:
- `STRIPE_CONNECT_CLIENT_ID`: For Stripe Connect payouts (starts with `ca_`)
- `DOTS_API_KEY`: For identity verification (if using DOTS)
- `DOTS_API_URL`: DOTS API endpoint (if using DOTS)

Note: `JWT_SECRET` and `SESSION_SECRET` are automatically generated by Render

## Step 4: Configure Stripe Webhook

1. After deployment, note your Render app URL (e.g., `https://pocketbounty-web.onrender.com`)
2. Go to Stripe Dashboard → Developers → Webhooks
3. Click "Add endpoint"
4. Set endpoint URL: `https://YOUR_RENDER_URL/webhooks/stripe`
   - Example: `https://pocketbounty-web.onrender.com/webhooks/stripe`
5. Select events to listen for:
   - `payment_intent.succeeded`
   - `payment_intent.payment_failed`
   - `account.updated` (for Stripe Connect)
   - `account.application.authorized`
   - `account.application.deauthorized`
6. Copy the signing secret (starts with `whsec_`)
7. Update `STRIPE_WEBHOOK_SECRET` in Render environment variables

## Step 5: Set Up Database

### Option A: Use Render PostgreSQL
1. In Render Dashboard, click "New +" → "PostgreSQL"
2. Create database with name `pocketbounty-db`
3. Render automatically links it to your web service

### Option B: Use External Database (Neon/Supabase)
1. Create database on your provider
2. Copy the connection string
3. Set `DATABASE_URL` in Render environment variables

### Initialize Database Schema:
After deployment, run the database initialization:
1. In Render Dashboard, go to your service
2. Click "Shell" tab
3. Run: `npm run db:push`

## Step 6: Configure Custom Domain

1. In Render Dashboard, go to your service
2. Click "Settings" → "Custom Domains"
3. Add `pocketbounty.life`
4. Update your domain's DNS records:
   - Type: CNAME
   - Name: @ (or www)
   - Value: Your Render subdomain (e.g., `pocketbounty-web.onrender.com`)

## Deployment Checklist

✅ **Files Created/Modified:**
- `.env.example` - Environment variable template
- `server/cors-setup.js` - CORS configuration for web and mobile
- `server/index.ts` - Added health endpoint and CORS
- `server/routes.ts` - Added Stripe webhook with raw body parsing
- `server/db.js` - Database abstraction layer
- `schema.sql` - PostgreSQL schema reference
- `scripts/init-db.js` - Database initialization script
- `render.yaml` - Render deployment configuration
- `Dockerfile` - Container configuration (optional)
- `.gitignore` - Updated with deployment artifacts
- `.github/workflows/lint.yml` - CI/CD pipeline

✅ **TODOs for Render Dashboard:**
1. ✅ Connect GitHub repository
2. ✅ Set environment variables (see Step 3)
3. ✅ Initialize database with `npm run db:push`
4. ✅ Configure Stripe webhook URL
5. ✅ Add custom domain DNS records

## Monitoring & Logs

- View logs: Render Dashboard → Your Service → "Logs" tab
- Monitor health: `https://YOUR_RENDER_URL/health`
- Database queries: Check `server/db.js` logs
- Stripe webhooks: Monitor in Stripe Dashboard → Webhooks

## Troubleshooting

### CORS Issues
- Check `server/cors-setup.js` includes your domain
- Verify `CORS_ORIGIN` environment variable is set

### Database Connection
- Verify `DATABASE_URL` is correct
- Check SSL settings in `server/db.js`
- Run `npm run db:push` to sync schema

### Stripe Webhooks
- Verify webhook URL ends with `/webhooks/stripe`
- Check `STRIPE_WEBHOOK_SECRET` matches Stripe dashboard
- Monitor webhook logs in Stripe dashboard

### Build Failures
- Check Node version (requires >=18)
- Verify all dependencies in package.json
- Check build logs in Render dashboard

## Support

For deployment issues:
- Render: https://render.com/docs
- Stripe: https://stripe.com/docs
- Database: Check your provider's documentation